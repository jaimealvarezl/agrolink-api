# AgroLink API - GitLab CI Pipeline
stages:
  - format-check
  - build
  - test
  - secret-detection

variables:
  SECRET_DETECTION_ENABLED: 'true'
  DOTNET_VERSION: '8.0.x'

# Code formatting check with CSharpier
format_check:
  stage: format-check
  image: mcr.microsoft.com/dotnet/sdk:8.0
  before_script:
    - dotnet tool restore
  script:
    - echo "üîç Checking code formatting with CSharpier..."
    - dotnet tool run csharpier check .
    - echo "‚úÖ Code formatting check passed!"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Build the solution
build:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "üî® Building AgroLink API..."
    - dotnet restore
    - dotnet build --no-restore --configuration Release
    - echo "‚úÖ Build completed successfully!"
  artifacts:
    paths:
      - "*/bin/"
      - "*/obj/"
    expire_in: 1 hour
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Run tests (when test projects are added)
test:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0
  script:
    - echo "üß™ Running tests..."
    - dotnet test --no-build --configuration Release --verbosity normal
    - echo "‚úÖ All tests passed!"
  dependencies:
    - build
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Security scanning
secret_detection:
  stage: secret-detection
  include:
    - template: Security/Secret-Detection.gitlab-ci.yml
